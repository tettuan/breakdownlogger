name: Version Check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  version-check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: "v2.x"

      - name: Clear cache and regenerate lockfile
        run: |
          rm -f deno.lock
          deno cache --reload mod.ts

      - name: Get latest tag
        id: get_latest_tag
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "latest_tag=${LATEST_TAG}" >> $GITHUB_OUTPUT

      - name: Get version from deno.json
        id: get_version
        run: |
          VERSION=$(deno eval "console.log(JSON.parse(Deno.readTextFileSync('deno.json')).version)")
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Check version consistency
        run: |
          CURRENT="v${{ steps.get_version.outputs.version }}"
          LATEST="${{ steps.get_latest_tag.outputs.latest_tag }}"
          # Sort versions; newest should be current or equal
          HIGHEST=$(printf '%s\n%s\n' "$CURRENT" "$LATEST" | sort -V | tail -1)
          if [ "$HIGHEST" != "$CURRENT" ]; then
            echo "Error: deno.json version ($CURRENT) is older than latest tag ($LATEST)"
            exit 1
          fi
          echo "Version check passed: deno.json=$CURRENT, latest tag=$LATEST"
