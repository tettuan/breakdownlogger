# ライブラリ概要

Denoで構築され、JSRへ公開されるデバッグ用ログ出力のライブラリである。
単体では動作せず、アプリケーションから呼ばれて利用される。

# 仕様

DebugLoggerは、アプリケーションの設定やパス解決のデバッグを支援するためのロギングシステムである。
ただしログファイルへの出力は行わず、テストコードから実行され標準出力（またはエラー出力）のみ行う。

## ユースケース

テストコード（ *_test.ts ） から呼び出される。
タイミングは任意だが、デバッグのために以下を重要なポイントとして想定する。

- 関数呼び出し前
- 引数の受け取り直後
- 返り値の直前
- 返り値の受け取り直後
- 重要な加工処理の前後

呼び出す時に、LOG_LEVEL だけでは情報が多すぎるため、以下の点に工夫する。

- 情報の量をコントロールできる
  - 未指定時は、1つの出力のログメッセージを先頭30文字以内に切る
  - 長さ指定時は、1つの出力のログメッセージを、それぞれの設定値に応じて切る
    - Short: 100文字
    - Long: 200文字
    - Whole: 全て
- ログ出力時にエラー箇所を指定できる「出力場所KEY」を持つ
  - ログを出力する箇所に固有のKEYを付与する（出力場所KEY）
    - ex. `new BreakdownLogger('hash1234')`
  - 出力に出力場所KEYを含めることで、問題の位置を特定できる

上記にによって、大量ログを出力記述しても、総出力量を抑えつつ、必要なときにピンポイントで情報量を増やして分析することができる。

- 例:
  - `LOG_LEVEL=debug deno test`
  - `LOG_LEVEL=debug LOG_LENGTH=S deno test tests/package/*` # S: Short
  - `LOG_LEVEL=debug LOG_LENGTH=L deno test tests/package/a_file_test.ts` # L:
    Long
  - `LOG_LEVEL=debug LOG_LENGTH=W LOG_KEY=hash1234 deno test tests/package/a_file_test.ts`
    # W: Whole

## 明確な要件

### 定義

#### ログレベル

1. DEBUG: 詳細なデバッグ情報
2. INFO: 一般的な情報
3. WARN: 警告
4. ERROR: エラー

#### ログ出力長

- Default: 30文字
- Short: 100文字
- Long: 200文字
- Whole: 全て

#### 出力項目

1. ログの出力項目
   - タイムスタンプ
   - ログレベル
   - 出力場所KEY
   - メッセージ内容
   - オブジェクトのダンプ（必要な場合）

### 実行時

ログの有効/無効切り替え

- テスト実行時に `LOG_LEVEL=debug deno test` のように指定
- `LOG_LENGTH`, `LOG_KEY` も指定可能

### 実行時の出力フィルター処理

1. ログレベルの制御
   - 設定されたレベル以上のログのみを出力
     - DEBUGがもっとも詳細
     - INFO,WARN,ERROR は、DEBUG指定時にも出力される
     - INFOはLOG_LEVEL指定なしで出力される
       - WARN,ERRORも出力される
     - WARNは警告時に出力される（警告的な分岐の中で使う）
     - ERRORはエラー時に出力される（エラーハンドリングの中で使う）

2. ログ出力長の制御

LOG_LENGTH=S LOG_LENGTH=L LOG_LENGTH=W LOG_LENGTH= # null, default

長さは、メッセージとデータを合わせた長さ。
「重要な情報をメッセージの先頭側へ置く」ことを重視するよう、利用者向け説明で強調する。短いときにも状態がわかるため。

3. 出力場所KEYの制御

- 渡されたKEYのみ出力する
- 区切り文字で複数指定可能
  - LOG_KEY=hash1234,hash2345
  - LOG_KEY=hash1234/hash2345
  - LOG_KEY=hash1234:hash2345
  - 区切り文字: ",/:" のいずれか

### 呼び出し元判定

- テストコードでのみ呼び出される。
- テストコードではない場所で呼び出された場合は、何もしない。
  - どうやって判定するのか？は、考えて欲しい

## 配布方法

- JSR へ公開するので、適した方法で構築すること。

### その他

- カスタムフォーマッターのサポート：不要
- 国際化対応：不要、英語。AIが理解すればよい。
- タイムゾーン処理：不要
- パフォーマンス：不要
- セキュリティ：不要

### 6. エラー処理

- ロガー自体のエラー処理方針：エラー出力のみ
- ログ書き込み失敗時の挙動：不要
- エラー通知メカニズム：不要

## 今後の拡張検討事項

不要

## 制約事項

1. 依存関係
   - 外部ライブラリへの依存を最小限に
   - Denoの標準ライブラリのみを使用

2. 互換性
   - TypeScript/JavaScript互換性の維持
   - Denoバージョンの互換性要件

3. サイズ
   - バンドルサイズの制限：できる限り最小化
   - メモリフットプリントの制限 ：できる限り最小化

4. export
   - 最小限の数
